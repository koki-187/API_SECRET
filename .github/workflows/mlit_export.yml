name: MLIT Export JP 2024Q3-2025Q2

# このGitHub Actionsワークフローは、国土交通省の不動産情報ライブラリAPIから
# 2024年第3四半期〜2025年第2四半期の全国不動産取引価格情報および成約価格情報を取得し、
# 日本語列名を持つ単一CSVにまとめて成果物としてアップロードします。

on:
  workflow_dispatch:
    # 手動トリガー専用

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      API_KEY: ${{ secrets.MLIT_API_KEY }}
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: Python のセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 必要なパッケージをインストール
        run: pip install requests

      - name: 国土交通省データを取得してCSVを作成する
        run: |
          python - <<'PY'
          import os, time, csv, json, requests, urllib.parse, sys

          # 環境変数からAPIキー取得
          api_key = (os.getenv("API_KEY") or "").strip()
          if not api_key:
            print("ERROR: MLIT_API_KEY が設定されていません", file=sys.stderr)
            sys.exit(1)

          # 対象期間: 2024年Q3〜2025年Q2
          targets = [
              (2024, 3),
              (2024, 4),
              (2025, 1),
              (2025, 2),
          ]
          # 47都道府県コード (01〜47)
          areas = [f"{i:02d}" for i in range(1, 48)]

          # CSV出力時の列名マッピング (英語キー -> 日本語列)
          field_map = [
              ("Prefecture", "都道府県"),
              ("Municipality", "市区町村"),
              ("DistrictName", "地区"),
              ("Region", "地域"),
              ("Type", "取引の種類"),
              ("TradePrice", "取引価格"),
              ("PricePerUnit", "坪単価"),
              ("Area", "面積"),
              ("UnitPrice", "単価"),
              ("FloorPlan", "間取り"),
              ("TotalFloorArea", "延床面積"),
              ("BuildingYear", "建築年"),
              ("Structure", "構造"),
              ("Use", "用途"),
              ("Purpose", "利用目的"),
              ("Direction", "前面道路方位"),
              ("Classification", "前面道路種類"),
              ("Breadth", "前面道路幅員(m)"),
              ("CityPlanning", "都市計画"),
              ("CoverageRatio", "建蔽率(%)"),
              ("FloorAreaRatio", "容積率(%)"),
              ("Period", "取引時点"),
              ("Renovation", "改装"),
              ("Remarks", "備考"),
              ("MunicipalityCode", "市区町村コード"),
          ]

          output_filename = "不動産価格情報_2024Q3_2025Q2.csv"

          def fetch_data(y, q, area):
            """APIリクエストを実行し、データ配列を返す。401/403ではクエリパラメータ方式にフォールバック。"""
            base_url = "https://www.reinfolib.mlit.go.jp/ex-api/external/XIT001"
            url = f"{base_url}?year={y}&quarter={q}&area={area}"
            # 3回まで試行
            for attempt in range(3):
              try:
                resp = requests.get(url, headers={"Ocp-Apim-Subscription-Key": api_key}, timeout=60)
              except Exception:
                time.sleep(2 * (attempt + 1))
                continue
              if resp.status_code == 200:
                try:
                  data = resp.json()
                except json.JSONDecodeError:
                  time.sleep(2 * (attempt + 1))
                  continue
                # オブジェクトの場合はdataキーを抽出
                if isinstance(data, dict):
                  return data.get("data", [])
                # 配列の場合はそのまま
                return data
              elif resp.status_code in (401, 403):
                # ヘッダで認証失敗時はクエリにキーを付与して再試行
                try:
                  fallback_url = url + ("&" if "?" in url else "?") + "subscription-key=" + urllib.parse.quote(api_key, safe="")
                  resp2 = requests.get(fallback_url, timeout=60)
                except Exception:
                  time.sleep(2 * (attempt + 1))
                  continue
                if resp2.status_code == 200:
                  try:
                    data = resp2.json()
                  except json.JSONDecodeError:
                    time.sleep(2 * (attempt + 1))
                    continue
                  if isinstance(data, dict):
                    return data.get("data", [])
                  return data
              elif resp.status_code in (429, 503):
                # レート制限やサーバ混雑時はリトライ
                time.sleep(2 * (attempt + 1))
                continue
              else:
                # その他のHTTPコードではデータなし
                return []
            return []

          total = 0
          with open(output_filename, "w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow([jp for _, jp in field_map])

            for y, q in targets:
              for area_code in areas:
                records = fetch_data(y, q, area_code)
                for record in records:
                  # レコードが辞書でなければ無視
                  if not isinstance(record, dict):
                    continue
                  row = [record.get(en, "") for en, _ in field_map]
                  writer.writerow(row)
                  total += 1
                # 負荷軽減のため短い待ち時間を入れる
                time.sleep(0.3)

          if total == 0:
            print("ERROR: 取得データがありません。APIキーやAPI状態を確認してください。", file=sys.stderr)
            sys.exit(2)
          else:
            print(f"SUCCESS: {total} 件のレコードを {output_filename} に出力しました")
          PY

      - name: CSV成果物をアップロード
        uses: actions/upload-artifact@v4
        with:
          name: real-estate-data-jp-2024Q3-2025Q2
          path: 不動産価格情報_2024Q3_2025Q2.csv
