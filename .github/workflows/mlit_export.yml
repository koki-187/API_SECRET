name: MLIT Export 2024Q3-2025Q2

on:
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      API_KEY: ${{ secrets.MLIT_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests

      - name: Fetch MLIT data and build CSV
        run: |
          python - <<'PY'
          import os, time, csv, json, requests, urllib.parse, sys

          KEY = (os.environ.get("API_KEY") or "").strip()
          if not KEY:
              print("ERROR: MLIT_API_KEY (repo secret) is missing.", file=sys.stderr)
              sys.exit(1)

          # Collect data for quarters 2024Q3 through 2025Q2 across all prefectures
          TARGETS = [(2024, 3), (2024, 4), (2025, 1), (2025, 2)]
          AREAS = [f"{i:02d}" for i in range(1, 48)]

          COLS = [
            "Prefecture", "Municipality", "DistrictName", "Type",
            "TradePrice", "PricePerUnit", "Area", "UnitPrice",
            "FloorPlan", "TotalFloorArea", "BuildingYear", "Structure",
            "Use", "Purpose", "Direction", "Classification", "Breadth",
            "CityPlanning", "CoverageRatio", "FloorAreaRatio",
            "Period", "Renovation", "Remarks",
            "MunicipalityCode", "Region"
          ]

          OUT = "MLIT_prices_2024Q3_2025Q2_allpref_alltypes.csv"

          def http_get(url: str):
              """
              Perform an HTTP GET request and return the status code and raw content.
              If a 401 or 403 is encountered, fallback to a query parameter with subscription-key.
              Gzip decompression is intentionally not performed here because requests
              already handles gzip decompression when content-encoding is set.
              """
              resp = requests.get(url, headers={"Ocp-Apim-Subscription-Key": KEY}, timeout=120)
              if resp.status_code in (401, 403):
                  url2 = url + ("&" if "?" in url else "?") + "subscription-key=" + urllib.parse.quote(KEY, safe="")
                  resp = requests.get(url2, timeout=120)
              return resp.status_code, resp.content

          def fetch(year: int, quarter: int, area: str):
              """
              Fetch data for a given year/quarter/area combination.
              Retries up to 3 times on transient errors (status 429/503) or JSON parse failures.
              """
              url = f"https://www.reinfolib.mlit.go.jp/ex-api/external/XIT001?year={year}&quarter={quarter}&area={area}"
              for k in range(3):
                  sc, raw = http_get(url)
                  if sc == 200:
                      try:
                          return json.loads(raw.decode("utf-8"))
                      except Exception:
                          # If parsing fails, wait and retry
                          time.sleep(2 * (k + 1))
                  elif sc in (429, 503):
                      # Rate limited or server busy; wait and retry
                      time.sleep(2 * (k + 1))
                  else:
                      # Other error codes: return empty list to skip
                      return []
              return []

          total = 0
          with open(OUT, "w", newline="", encoding="utf-8") as f:
              writer = csv.writer(f)
              writer.writerow(COLS)
              for y, q in TARGETS:
                  for a in AREAS:
                      data = fetch(y, q, a) or []
                      for r in data:
                          writer.writerow([r.get(c, "") for c in COLS])
                          total += 1
                      time.sleep(0.35)

          if total == 0:
              print("ERROR: No records fetched. Check MLIT_API_KEY or API availability.", file=sys.stderr)
              sys.exit(2)

          print("OK: wrote", OUT, "records:", total)
          PY

      - name: Zip CSV (optional)
        run: zip -9 MLIT_prices_2024Q3_2025Q2_allpref_alltypes.zip MLIT_prices_2024Q3_2025Q2_allpref_alltypes.csv

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlit-csv-2024Q3-2025Q2
          path: |
            MLIT_prices_2024Q3_2025Q2_allpref_alltypes.csv
            MLIT_prices_2024Q3_2025Q2_allpref_alltypes.zip
